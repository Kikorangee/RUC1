<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RUC Details</title>
    <link rel="stylesheet" href__="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href__="style.css">
</head>
<body>
    <!-- NEW: Simplified loading spinner -->
    <div id="loading" class="text-center">
        <div class="spinner-container">
            <div class="spinner"></div>
            <p>Loading vehicle RUC data...</p>
        </div>
    </div>

    <!-- NEW: Error message container -->
    <div id="error-message" class="alert alert-danger" style="display:none;"></div>

    <!-- Container for the add-in content -->
    <div id="rucAddin" style="display:none;">
        <h2>Vehicle RUC Details</h2>
        <p>This list shows the latest RUC status logs for your vehicles.</p>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Vehicle</th>
                    <th>Last RUC Log Date</th>
                    <th>Odometer (km)</th>
                    <th>Distance (km)</th>
                    <th>RUC Label Number</th>
                </tr>
            </thead>
            <tbody id="ruc-table-body">
                <!-- Data will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="geotab.js"></script>

    <!-- REFACTORED: Complete script rewrite for efficiency and reliability -->
    <script>
        geotab.addin.ruc = function (api, state) {
            'use strict';

            // Function to fetch and display data
            // Using modern async/await for clarity and reliability
            const loadRucData = async () => {
                try {
                    // 1. Get all vehicles in the user's scope in one call
                    const vehicles = await api.call("Get", {
                        typeName: "Device",
                        search: {
                            groups: state.getGroups()
                        }
                    });

                    if (!vehicles || vehicles.length === 0) {
                        $('#loading').hide();
                        $('#rucAddin').show().find('tbody').html('<tr><td colspan="5">No vehicles found in your scope.</td></tr>');
                        return;
                    }

                    const vehicleIds = vehicles.map(v => v.id);

                    // 2. Get all relevant DutyStatusLogs for all vehicles in ONE call
                    // This is vastly more efficient than one call per vehicle
                    const statusLogs = await api.call("Get", {
                        typeName: "DutyStatusLog",
                        search: {
                            deviceSearch: { id: vehicleIds },
                            diagnosticSearch: { id: "diagnosticRUCDistanceId" }
                        }
                    });

                    // 3. Process the logs for easy lookup
                    const logsByVehicleId = {};
                    for (const log of statusLogs) {
                        const vehicleId = log.device.id;
                        // Store only the latest log for each vehicle
                        if (!logsByVehicleId[vehicleId] || new Date(log.dateTime) > new Date(logsByVehicleId[vehicleId].dateTime)) {
                            logsByVehicleId[vehicleId] = log;
                        }
                    }

                    // 4. Build the HTML table content
                    let tableContent = '';
                    for (const vehicle of vehicles) {
                        const latestLog = logsByVehicleId[vehicle.id];
                        
                        // Use Intl.NumberFormat for better number display
                        const odometer = latestLog ? new Intl.NumberFormat('en-NZ').format(Math.round(latestLog.odometer / 1000)) : 'N/A';
                        const distance = latestLog ? new Intl.NumberFormat('en-NZ').format(latestLog.distance) : 'N/A';

                        tableContent += `
                            <tr>
                                <td>${vehicle.name}</td>
                                <td>${latestLog ? new Date(latestLog.dateTime).toLocaleString('en-NZ') : 'No RUC Log'}</td>
                                <td>${odometer}</td>
                                <td>${distance}</td>
                                <td>${latestLog ? latestLog.notes || 'N/A' : 'N/A'}</td>
                            </tr>
                        `;
                    }
                    
                    // 5. Display the data and hide the spinner
                    $('#ruc-table-body').html(tableContent);
                    $('#loading').hide();
                    $('#rucAddin').show();

                } catch (error) {
                    // If anything fails, show an error message
                    console.error("Failed to load RUC data:", error);
                    $('#loading').hide();
                    $('#error-message').text('An error occurred while loading data: ' + error.message).show();
                }
            };

            return {
                initialize: function (api, state, callback) {
                    // When the add-in starts, call our main function
                    loadRucData();
                    if (callback) {
                        callback();
                    }
                },
                focus: function (api, state) {
                    // You could optionally refresh data when the user clicks back to the tab
                    // loadRucData(); 
                },
                blur: function () {
                    // Fires when the user leaves the add-in
                }
            };
        };
    </script>
</body>
</html>
