<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RUC Details</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loading" class="text-center">
        <div class="spinner-container">
            <div class="spinner"></div>
            <p>Loading vehicle RUC data...</p>
        </div>
    </div>

    <div id="error-message" class="alert alert-danger" style="display:none;"></div>

    <div id="rucAddin" style="display:none;">
        <h2>Vehicle RUC Details</h2>
        <p>This list shows the latest RUC status logs for your vehicles.</p>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Vehicle</th>
                    <th>Last RUC Log Date</th>
                    <th>Odometer (km)</th>
                    <th>Distance (km)</th>
                    <th>RUC Label Number</th>
                </tr>
            </thead>
            <tbody id="ruc-table-body">
            </tbody>
        </table>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <script>
        console.log("RUC script starting...");
        
        geotab.addin.ruc = function (api, state) {
            'use strict';
            console.log("RUC add-in function called");

            const loadRucData = async () => {
                try {
                    console.log("RUC: Starting loadRucData function");
                    console.log("RUC: API available:", !!api);
                    console.log("RUC: State available:", !!state);
                    
                    // Show loading
                    $('#loading').show();
                    $('#rucAddin').hide();
                    $('#error-message').hide();
                    
                    console.log("RUC: Getting devices from Geotab API...");
                    
                    const devices = await api.call("Get", {
                        typeName: "Device",
                        search: {
                            groups: state.getGroups()
                        }
                    });

                    console.log("RUC: API call completed");
                    console.log("RUC: Found devices:", devices.length);

                    if (!devices || devices.length === 0) {
                        console.log("RUC: No devices found");
                        $('#loading').hide();
                        $('#rucAddin').show();
                        $('#ruc-table-body').html('<tr><td colspan="5">No vehicles found in your scope.</td></tr>');
                        return;
                    }

                    let tableContent = '';
                    for (const vehicle of devices) {
                        console.log("RUC: Processing vehicle:", vehicle.name);
                        tableContent += `
                            <tr>
                                <td><strong>${vehicle.name}</strong></td>
                                <td>No RUC logs yet</td>
                                <td>--</td>
                                <td>--</td>
                                <td>${vehicle.licensePlate || '--'}</td>
                            </tr>
                        `;
                    }
                    
                    console.log("RUC: Updating table with", devices.length, "vehicles");
                    $('#ruc-table-body').html(tableContent);
                    $('#loading').hide();
                    $('#rucAddin').show();
                    console.log("RUC: Table updated successfully");

                } catch (error) {
                    console.error("RUC: Error loading data:", error);
                    $('#loading').hide();
                    $('#error-message').text('Error: ' + error.message).show();
                }
            };

            return {
                initialize: function (api, state, callback) {
                    console.log("RUC: Initialize function called");
                    console.log("RUC: API object:", !!api);
                    console.log("RUC: State object:", !!state);
                    loadRucData();
                    if (callback) {
                        console.log("RUC: Calling callback");
                        callback();
                    }
                },
                focus: function (api, state) {
                    console.log("RUC: Focus function called");
                },
                blur: function () {
                    console.log("RUC: Blur function called");
                }
            };
        };
        
        console.log("RUC script loaded completely");
    </script>
</body>
</html>
